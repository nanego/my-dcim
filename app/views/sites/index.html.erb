<%= render 'layouts/breadcrumb', breadcrumb_variables: { 'Paramètres' => modeles_url, 'Salles' => '' } %>

<div class="container-fluid">

  <div class="row">

    <div class="col-md-3">
      <%= render 'pages/params_menu' %>
    </div>

    <div class="col-md-9">

      <div class="page-header">
        <%= link_to new_site_path, class: 'btn btn-primary' do %>
          <span class="glyphicon glyphicon-plus"></span>
          Ajouter un site
        <% end %>
        <h1>Sites</h1>
      </div>

      <div id="map" style="height: 450px;margin-bottom: 16px;"></div>

      <div class="table-responsive">
        <table class="table table-striped table-bordered table-hover">
          <thead>
          <tr>
            <th>Nom</th>
            <th>Position</th>
            <th></th>
            <th></th>
            <th></th>
          </tr>
          </thead>

          <tbody>
          <%= content_tag_for(:tr, @sites) do |site| %>
            <td><b><%= site %></b></td>
            <td><%= site.position %></td>
            <td><%= pluralize site.rooms.count, 'salle', 'salles' %></td>
            <td><%= link_to 'Modifier', edit_site_path(site), class: 'btn btn-default' %></td>
            <td><%= link_to 'Supprimer', site, method: :delete, data: { confirm: 'Est-ce que vous confirmez la suppression définitive de ce site ?' }, class: 'btn btn-warning' %></td>
          <% end %>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.8.0/dist/leaflet.css"
      integrity="sha512-hoalWLoI8r4UszCkZ5kL8vayOGVae1oxXe/2A4AO6J9+580uKHDO3JdHb7NzwwzK5xr/Fs0W40kiNHxM9vyTtQ=="
      crossorigin=""/>
<script src="https://unpkg.com/leaflet@1.8.0/dist/leaflet.js"
        integrity="sha512-BB3hKbKWOc9Ez/TAwyWxNXeoV9c1v6FIeYiBieIWkpLjauysF18NzgR1MBNBXf8/KABdlkX68nAhlwcDFLGPCQ=="
        crossorigin=""></script>
<script>
    var min_lat = <%= @sites.minimum(:latitude) %>;
    var max_lat = <%= @sites.maximum(:latitude) %>;
    var min_lon = <%= @sites.minimum(:longitude) %>;
    var max_lon = <%= @sites.maximum(:longitude) %>;

    var map = L.map('map').setView([(max_lat + min_lat) / 2, (max_lon + min_lon) / 2], 6);
    L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token={accessToken}', {
        attribution: 'Données &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>, Fond de carte © <a href="https://www.mapbox.com/">Mapbox</a>',
        maxZoom: 18,
        id: 'mapbox/streets-v11',
        tileSize: 512,
        zoomOffset: -1,
        accessToken: '<%= Rails.application.credentials.mapbox[:access_token] %>'
    }).addTo(map);

    <% @sites.reject{|s|s.latitude.blank? || s.longitude.blank?}.each do |site| %>
    var marker<%= site.id %> = L.marker([<%= site.latitude %>, <%= site.longitude %>]).addTo(map);
    marker<%= site.id %>.bindPopup("<%= site.name %>"); //.openPopup();
    <% end %>


</script>
